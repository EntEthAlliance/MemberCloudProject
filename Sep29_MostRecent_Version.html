<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EEA Member Cloud</title>
<style>
  :root{
    --bg-top:#db65b1; --bg-mid:#f2a263; --bg-bottom:#b682ff;
    --text:#1b2340;
    --tooltip-bg:rgba(18,24,40,.92); --tooltip-text:#fff; --focus-ring:#A78BFA;
    --tier-a:#FFC84A; --tier-b1:#C18CFF; --tier-b23:#F5B287; --tier-d:#4CC76E;
    --panel-bg:rgba(255,255,255,.85); --panel-border:rgba(255,255,255,.55);
  }
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
    color:var(--text);
    background:
      radial-gradient(180% 100% at 50% 0%, var(--bg-top) 0%, transparent 55%),
      radial-gradient(140% 120% at 50% 60%, var(--bg-mid) 0%, transparent 60%),
      radial-gradient(160% 120% at 50% 100%, var(--bg-bottom) 0%, transparent 65%),
      linear-gradient(180deg,#f89a6b 0%,#c384ff 100%);
    background-attachment:fixed;
  }
  .bar{position:fixed;inset:0 0 auto 0;display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--panel-bg);backdrop-filter:blur(8px) saturate(1.05);border-bottom:1px solid var(--panel-border);z-index:20}
  .bar h1{font-size:16px;margin:0}
  .controls{display:flex;gap:10px;align-items:center}
  .button{border:1px solid rgba(255,255,255,.6);background:rgba(255,255,255,.75);color:var(--text);border-radius:999px;padding:8px 12px;font-size:14px;cursor:pointer;box-shadow:0 1px 0 rgba(255,255,255,.6) inset}
  .wrap{padding-block-start:58px}

  /* Cloud area */
  .cloud-wrap{position:relative;width:100%;height:82vh;min-height:560px;display:grid;place-items:stretch}

  /* Legend BELOW the cloud (no overlap) */
  .legend-row{display:flex;justify-content:center;padding:8px 12px 14px}
  .legend{
    position:static; transform:none;
    background:rgba(255,255,255,.72);
    backdrop-filter:blur(8px);
    border:1px solid rgba(255,255,255,.65);
    border-radius:999px; padding:8px 12px;
    box-shadow:0 10px 24px rgba(0,0,0,.12);
    font-size:12px; color:var(--text);
  }
  .legend ul{list-style:none;margin:0;padding:0;display:flex;gap:14px;align-items:center}
  .legend li{display:flex;gap:8px;align-items:center}
  .dot{width:12px;height:12px;border-radius:999px;border:1px solid rgba(0,0,0,.18)}
  .a{background:var(--tier-a)} .b1{background:var(--tier-b1)} .b23{background:var(--tier-b23)} .d{background:var(--tier-d)}

  .tooltip{position:absolute;pointer-events:none;z-index:10;background:var(--tooltip-bg);color:var(--tooltip-text);padding:.75rem .9rem;border-radius:.9rem;box-shadow:0 10px 28px rgba(0,0,0,.28);transform:translate(-50%,calc(-100% - 14px));opacity:0;transition:opacity .15s ease,transform .15s ease}
  .tooltip.show{opacity:1;transform:translate(-50%,calc(-100% - 8px))}
  .tooltip .logo{inline-size:32px;block-size:32px;border-radius:.5rem;object-fit:contain;background:#fff;margin-right:.6rem}
  .tooltip .row{display:flex;align-items:center;gap:.6rem;margin:0 0 .25rem 0}
  .tooltip .name{font-weight:600;letter-spacing:.2px}
  .tooltip .meta{font-size:.82rem;opacity:.85;margin-top:.15rem}

  .node-label{
    font-weight:600;fill:#fff;opacity:0;dominant-baseline:middle;text-anchor:middle;pointer-events:none;
    font-size:14px;transition:opacity .3s ease;
  }
  .node-label.show{opacity:.92}
  .focus-ring{fill:none;stroke:var(--focus-ring);stroke-width:3;opacity:0}
  g[tabindex="0"]:focus .focus-ring{opacity:.9}

  .details{position:absolute;right:16px;top:16px;bottom:16px;inline-size:min(420px,92vw);background:var(--panel-bg);border-radius:16px;backdrop-filter:blur(10px);box-shadow:0 12px 30px rgba(0,0,0,.25);border:1px solid var(--panel-border);padding:16px 16px 20px;display:grid;grid-template-rows:auto 1fr;gap:12px;overflow:auto}
  .details[hidden]{display:none}
  .details-close{position:absolute;right:12px;top:12px;border:0;background:rgba(255,255,255,.85);border-radius:10px;padding:6px 10px;cursor:pointer;color:var(--text)}
  .details-header{display:flex;gap:12px;align-items:center;margin-top:8px}
  .details-logo{inline-size:40px;block-size:40px;border-radius:8px;background:#fff;object-fit:contain}
  .muted{margin:0;color:#334155;font-size:.9rem}
  .details-grid{display:grid;grid-template-columns:auto 1fr;gap:10px 12px;margin:8px 0 0}
  .details a{color:#1f49ff;text-decoration:underline}

  .error-panel{position:fixed;left:16px;bottom:16px;z-index:30;background:rgba(255,255,255,.92);border:1px solid var(--panel-border);color:#0f172a;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.18);padding:10px 12px;max-width:min(520px,92vw);font-size:12px;line-height:1.3}
  .ok{color:#065f46}
</style>
</head>
<body>
  <div class="bar">
    <h1>EEA Member Cloud</h1>
    <div class="controls">
      <span id="admin-badge" class="button" style="display:none;">Admin view</span>
      <button id="toggle-admin" class="button">Admin: Off</button>
      <label class="button" for="file-input">Load CSV / JSON</label>
      <input id="file-input" type="file" accept=".csv,.json, text/csv, application/json" hidden />
    </div>
  </div>

  <div class="wrap">
    <!-- Cloud -->
    <div class="cloud-wrap" id="member-cloud-root" aria-label="EEA Member Cloud visualization">
      <div id="tooltip" class="tooltip" role="dialog" aria-live="polite">
        <div class="row">
          <img class="logo" id="tt-logo" alt="" />
          <div>
            <div class="name" id="tt-name"></div>
            <div class="meta" id="tt-tier"></div>
          </div>
        </div>
      </div>

      <aside id="details" class="details" aria-live="polite" aria-label="Member details" hidden>
        <button id="details-close" class="details-close" aria-label="Close details">✕</button>
        <div class="details-header">
          <img id="details-logo" class="details-logo" alt="" />
          <div class="details-title">
            <h3 id="details-name">Member</h3>
            <p id="details-class" class="muted" hidden></p>
          </div>
        </div>
        <dl class="details-grid">
          <dt data-admin-only>Record ID</dt><dd data-admin-only id="details-id">—</dd>
          <dt>Company</dt><dd id="details-company">—</dd>
          <dt>About</dt><dd id="details-description">—</dd>
          <dt>URL</dt><dd id="details-url">—</dd>
          <dt data-admin-only>Country/Region of operations</dt><dd data-admin-only id="details-country">—</dd>
          <dt>Industry category</dt><dd id="details-industry">—</dd>
          <dt data-admin-only>Member category</dt><dd data-admin-only id="details-tier">—</dd>
          <dt>X</dt><dd id="details-x">—</dd>
          <dt>LinkedIn</dt><dd id="details-linkedin">—</dd>
        </dl>
      </aside>
    </div>

    <!-- Legend BELOW the cloud -->
    <div class="legend-row">
      <div class="legend">
        <ul>
          <li><span class="dot a"></span>A-Tier</li>
          <li><span class="dot b1"></span>B1-Tier</li>
          <li><span class="dot b23"></span>B2+B3-Tier</li>
          <li><span class="dot d"></span>D-Tier</li>
        </ul>
      </div>
    </div>
  </div>

  <div id="err" class="error-panel" style="display:none;"></div>

  <!-- defs -->
  <svg width="0" height="0" style="position:absolute">
    <defs>
      <filter id="bubbleGlass" x="-50%" y="-50%" width="200%" height="200%">
        <feGaussianBlur in="SourceGraphic" stdDeviation="0" result="base"/>
        <feFlood flood-color="white" flood-opacity=".2" result="glow"/>
        <feComposite in="glow" in2="base" operator="in" result="inner"/>
        <feGaussianBlur in="inner" stdDeviation="2" result="soft"/>
        <feBlend in="base" in2="soft" mode="normal"/>
      </filter>
      <radialGradient id="bubbleFillGradient" cx="50%" cy="30%" r="70%">
        <stop offset="0%" stop-color="#ffffff" stop-opacity=".25"></stop>
        <stop offset="100%" stop-color="#ffffff" stop-opacity=".05"></stop>
      </radialGradient>
    </defs>
  </svg>

  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script>
  (function(){
    /* --- Brand aliases → local files (extend as needed) --- */
    const brandLogoMap = {
      "microsoft": "/logos/microsoft.svg",
      "jp morgan": "/logos/jpmorgan.svg", "jpmorgan": "/logos/jpmorgan.svg",
      "accenture": "/logos/accenture.svg",
      "ey": "/logos/ey.svg", "ernst & young": "/logos/ey.svg",
      "lido": "/logos/lido.svg",
      "consensys": "/logos/consensys.svg",
      "chainlink": "/logos/chainlink.svg", "chainlink labs": "/logos/chainlink.svg",
      "trail of bits": "/logos/trail-of-bits.svg",
      "matter labs": "/logos/matterlabs.svg",
      "circle": "/logos/circle.svg",
      "ethereum": "/logos/ethereum.svg",
      "the graph": "/logos/the-graph.svg",
      "l2beat": "/logos/l2beat.svg",
      "kaleido": "/logos/kaleido.svg",
      "wanchain": "/logos/wanchain.svg",
      "gaia": "/logos/gaia.svg",
      "coinchange": "/logos/coinchange.svg",
      "franklin": "/logos/franklin.svg",
      "arche capital": "/logos/A1-Class/Arche Capital.png",
      "erc3643": "/logos/B1-Class/ERC3643.png",
      "fnality": "/logos/B2_Class/Fnality.png",
      "fnality international": "/logos/B2_Class/Fnality.png"
    };

    const root = document.getElementById('member-cloud-root');
    const errBox = document.getElementById('err');

    const params = new URLSearchParams(location.search);
    const IS_ADMIN = params.get('admin') === '1';
    const adminBadge = document.getElementById('admin-badge');
    const adminBtn = document.getElementById('toggle-admin');
    if(IS_ADMIN){ adminBadge.style.display='inline-block'; adminBtn.textContent='Admin: On'; }
    adminBtn.addEventListener('click', ()=>{
      const p = new URLSearchParams(location.search);
      if(p.get('admin') === '1') p.delete('admin'); else p.set('admin','1');
      location.search = p.toString();
    });

    function ensureHeight(){
      const h = Math.max(560, Math.floor((window.innerHeight || 900) * 0.82));
      root.style.minHeight = h + 'px';
      root.style.height = h + 'px';
    }
    ensureHeight(); window.addEventListener('resize', ensureHeight, {passive:true});

    function showError(msg, detail){
      errBox.style.display = 'block';
      errBox.innerHTML = `<strong>Load error</strong><br>${msg}${detail?`<br><small>${detail}</small>`:''}`;
      console.error('[EEA Cloud]', msg, detail || '');
    }
    function showInfo(msg){
      errBox.style.display = 'block';
      errBox.innerHTML = `<span class="ok">✓</span> ${msg}`;
      setTimeout(()=>{ errBox.style.display='none'; }, 3000);
      console.log('[EEA Cloud]', msg);
    }

    document.getElementById('file-input').addEventListener('change', async (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      try{
        const text = await file.text();
        const rows = smartParse(text);
        const data = normalizeRows(rows);
        if(!data.length){ showError('No usable rows found in the file. Make sure your CSV has a header row.'); return; }
        renderCloud(data);
        showInfo(`Loaded ${data.length} members from "${file.name}".`);
      }catch(err){ showError('Could not read that file.', err.message || String(err)); }
    });

    requestAnimationFrame(async ()=>{
      const dataPath = params.get('data') || '';
      if(!dataPath) return;
      try{
        const lower = dataPath.toLowerCase();
        if(lower.endsWith('.csv')){
          const resp = await fetch(dataPath, {cache:'no-store'});
          const text = await resp.text();
          const rows = smartParse(text);
          const data = normalizeRows(rows);
          if(!data.length){ showError('CSV loaded but contained no usable rows.'); return; }
          renderCloud(data);
          showInfo(`Loaded ${data.length} members from "${dataPath}".`);
        }else if(lower.endsWith('.json')){
          const resp = await fetch(dataPath, {cache:'no-store'});
          const json = await resp.json();
          const rows = Array.isArray(json) ? json : (json.data || json.rows || []);
          const data = normalizeRows(rows);
          if(!data.length){ showError('JSON loaded but contained no usable rows.'); return; }
          renderCloud(data);
          showInfo(`Loaded ${data.length} members from "${dataPath}".`);
        }
      }catch(err){ showError('Fetch failed (often due to opening the file directly). Use the "Load CSV / JSON" button or run a local server.', err.message||String(err)); }
    });

    function cleanStr(s){
      return String(s||'').replace(/\uFEFF/g,'').replace(/[\u200B-\u200D]/g,'').replace(/[\u00A0\u2007\u202F]/g,' ').trim();
    }
    function smartParse(text){
      if(!window.d3 || !d3.csvParse){ throw new Error('D3 failed to load.'); }
      const cleaned = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n');
      const firstLine = cleaned.split('\n').find(l => l.trim().length>0) || '';
      const commaCount = (firstLine.match(/,/g)||[]).length;
      const semiCount  = (firstLine.match(/;/g)||[]).length;
      const delim = semiCount > commaCount ? ';' : ',';
      const parser = d3.dsvFormat(delim);
      const rows = parser.parse(cleaned);
      return rows.map(row=>{
        const out = {};
        for(const k in row){ if(!Object.prototype.hasOwnProperty.call(row,k)) continue;
          out[cleanStr(k)] = cleanStr(row[k]);
        }
        return out;
      });
    }

    function normalizeRows(rows){
      return rows.map((row, i)=>{
        const map = {};
        for(const k in row){ if(!Object.prototype.hasOwnProperty.call(row,k)) continue;
          map[cleanStr(k).toLowerCase()] = cleanStr(row[k]);
        }
        const val = (...keys)=> { for(const k of keys){ const kk = k.toLowerCase(); if(map[kk] != null && map[kk] !== '') return map[kk]; } return ''; };

        const recordId = val('tag record id','record id','id','rid');
        const company  = val('company','company name','companyname','organization','org','label','name') || `Member ${i+1}`;
        const description = val('about','description','desc','bio','summary');
        const website = val('website url','url','website','site','homepage');
        const country = val('country/region of operations','country / region of operations','country','region','location');
        const industry = val('industry category','industry','industry tag test','industry tag','sector','vertical');
        const membershipClassRaw = val('eea membership class','membership class','member category','class','tier','membership','eea class');
        const membershipLevel = parseLevel(membershipClassRaw);
        const logo = val('logo','logo url','image','icon');
        const x = val('x','x handle','twitter','twitter handle','x username','twitter username');
        const linkedin = val('linkedin','linkedin url','linkedin company','linkedin page','linked in');

        return { recordId, company, description, website, country, industry, membershipClass: membershipClassRaw, membershipLevel, logo, x, linkedin };
      }).filter(d => d.company && d.company !== '-');
    }

    function parseLevel(v){
      if(v == null) return 2;
      const s = String(v).trim();
      if(!s) return 2;
      const n = Number(s);
      if(Number.isFinite(n) && n >= 1 && n <= 4) return n|0;
      const m = s.match(/[1-4]/);
      return m ? Number(m[0]) : 2;
    }

    /* ---------- Visualization (tier background + logo + name) ---------- */
    let resizeHandler = null;

    function renderCloud(data){
      errBox.style.display = 'none';
      d3.select(root).select('svg.cloud').remove();
      if(resizeHandler){ window.removeEventListener('resize', resizeHandler); }

      document.querySelectorAll('[data-admin-only]').forEach(el=>{ el.style.display = IS_ADMIN ? 'inline' : 'none'; });
      document.getElementById('admin-badge').style.display = IS_ADMIN ? 'inline-block' : 'none';

      const tooltip = document.getElementById('tooltip');
      const ttLogo = document.getElementById('tt-logo');
      const ttName = document.getElementById('tt-name');
      const ttTier = document.getElementById('tt-tier');
      const details = document.getElementById('details');
      const detailsClose = document.getElementById('details-close');
      const dLogo = document.getElementById('details-logo');
      const dName = document.getElementById('details-name');
      const dId = document.getElementById('details-id');
      const dCompany = document.getElementById('details-company');
      const dDesc = document.getElementById('details-description');
      const dUrl = document.getElementById('details-url');
      const dCountry = document.getElementById('details-country');
      const dIndustry = document.getElementById('details-industry');
      const dTier = document.getElementById('details-tier');
      const dX = document.getElementById('details-x');
      const dLinkedIn = document.getElementById('details-linkedin');
      detailsClose.onclick = ()=> details.hidden = true;

      const rect = root.getBoundingClientRect();
      let W = Math.max(320, rect.width || window.innerWidth || 1000);
      let H = Math.max(560, rect.height || Math.floor((window.innerHeight||900)*0.82));

      const svg = d3.select(root).append('svg')
        .attr('class','cloud').attr('width', W).attr('height', H)
        .attr('role','img').attr('aria-label','Interactive cluster of EEA members');

      const g = svg.append('g');

      const levelToColor = new Map([
        [1, css('--tier-a')],[2, css('--tier-b1')],[3, css('--tier-b23')],[4, css('--tier-d')]
      ]);
      const rScale = d3.scaleLinear().domain([1,4]).range([26, 68]);

      const nodes = data.map((d,i)=>{
        const lvl = (d.membershipLevel>=1 && d.membershipLevel<=4) ? d.membershipLevel : 2;
        const r = rScale(lvl);
        return {
          id:i, ...d, r,
          color: levelToColor.get(lvl) || css('--tier-b1'),
          x: Math.random()*(W-2*r)+r,
          y: Math.random()*(H-2*r)+r
        };
      });

      const node = g.selectAll('g.node')
        .data(nodes, d=>d.id)
        .join(enter=>{
          const gn = enter.append('g')
            .attr('class','node')
            .attr('tabindex', 0).attr('role','button')
            .attr('aria-label', d=> `${d.company}. Activate for details.`)
            .style('cursor','pointer')
            .on('click', (event,d)=> showDetails(d))
            .on('keydown', (event,d)=>{ if(event.key==='Enter'||event.key===' '){ event.preventDefault(); showDetails(d); }})
            .on('pointerenter', (event,d)=> showTooltip(event,d))
            .on('pointermove', (event)=> moveTooltip(event))
            .on('pointerleave', hideTooltip);

          gn.append('circle').attr('class','focus-ring').attr('r', d=>d.r+8);

          /* Tier-tinted background (full bubble color) */
          gn.append('circle')
            .attr('class', 'tier-bg')
            .attr('r', d=>d.r)
            .attr('fill', d=>d.color)
            .attr('fill-opacity', 0.32);

          /* Glossy white radial highlight + subtle rim */
          gn.append('circle')
            .attr('class', 'bubble-gloss')
            .attr('r', d=>d.r)
            .attr('fill','url(#bubbleFillGradient)')
            .attr('filter','url(#bubbleGlass)')
            .attr('stroke', d=>d.color).attr('stroke-opacity', .35).attr('stroke-width', 1.2)
            .style('mix-blend-mode','screen');

          // Clip to keep logo inside circle
          gn.append('clipPath').attr('id', d => `clip-${d.id}`).append('circle').attr('r', d=>d.r);

          // 1) IMAGE FIRST (so label sits on top)
          const img = gn.append('image')
            .attr('clip-path', d => `url(#clip-${d.id})`)
            .attr('preserveAspectRatio','xMidYMid meet')
            .attr('referrerpolicy','no-referrer')
            .attr('crossorigin','anonymous')
            .attr('x', d => - (d.r * 0.88))
            .attr('y', d => - (d.r * 0.88))
            .attr('width', d => d.r * 1.76)
            .attr('height', d => d.r * 1.76)
            .attr('opacity', 0);

          // 2) LABEL AFTER → hidden by default, only shows if logo fails
          const label = gn.append('text')
            .attr('class','node-label')
            .attr('font-size', d => Math.max(12, Math.min(20, d.r * 0.38)))
            .attr('y', 0)
            .text(d => brandShort(d.company));

          // For each node, try fallbacks; on load, record the final URL used
          gn.each(function(d){
            const el = this.querySelector('image');
            const textEl = this.querySelector('text.node-label');
            const candidates = logoCandidates(d);
            if(!candidates.length) {
              // No logo candidates, show text
              textEl.classList.add('show');
              return;
            }
            tryNext(el, candidates, ()=>{
              // All logos failed, show text fallback
              textEl.classList.add('show');
            });
            el.addEventListener('load', ()=>{
              el.setAttribute('opacity','1');
              // ✅ remember the URL that actually worked
              d._logoURL = el.__currentURL || el.getAttribute('href') ||
                           (el.href && el.href.baseVal) ||
                           el.getAttributeNS('http://www.w3.org/1999/xlink','href') || '';
              // Logo loaded successfully - keep text hidden
            }, {once:true});
          });

          return gn;
        });

      node.attr('transform', d => `translate(${d.x},${d.y})`);

      const simulation = d3.forceSimulation(nodes)
        .force('x', d3.forceX(W/2).strength(0.05))
        .force('y', d3.forceY(H/2).strength(0.06))
        .force('collision', d3.forceCollide().radius(d => d.r + 6).iterations(2))
        .alpha(1)
        .on('tick', ()=> node.attr('transform', d => `translate(${d.x},${d.y})`));
      for(let i=0;i<60;i++) simulation.tick();

      window.addEventListener('resize', resizeHandler = ()=>{
        ensureHeight();
        const r2 = root.getBoundingClientRect();
        const W2 = Math.max(320, r2.width || window.innerWidth || 1000);
        const H2 = Math.max(560, r2.height || Math.floor((window.innerHeight||900)*0.82));
        d3.select(root).select('svg.cloud').attr('width', W2).attr('height', H2);
        simulation.force('x', d3.forceX(W2/2).strength(0.05));
        simulation.force('y', d3.forceY(H2/2).strength(0.06));
        simulation.alpha(0.5).restart();
      }, {passive:true});

      function brandShort(name){
        if(!name) return '—';
        const replacements = {'microsoft':'Microsoft','lido':'LIDO','l2beat':'L2BEAT','ey':'EY',
                              'consensys':'consensys','gaia':'gaia','trail of bits':'TRAIL\nOF BITS'};
        const key = Object.keys(replacements).find(k=>name.toLowerCase().includes(k));
        if(key) return replacements[key];
        const max = 12; return name.length<=max ? name : name.slice(0,max-1)+'…';
      }

      /* tooltip & details – use the recorded URL if available */
      function showTooltip(evt, d){
        ttName.textContent = d.company || '';
        if(IS_ADMIN && (d.membershipClass || d.membershipLevel)){
          const lvlTxt = d.membershipLevel ? ` (level ${d.membershipLevel})` : '';
          ttTier.textContent = `Member category: ${d.membershipClass || ''}${lvlTxt}`;
          ttTier.style.display = 'block';
        } else { ttTier.textContent = ''; ttTier.style.display = 'none'; }
        const imgURL = d._logoURL || (logoCandidates(d)[0] || '');
        if(imgURL){ ttLogo.src = imgURL; ttLogo.style.display='block'; ttLogo.alt = (d.company||'') + ' logo'; }
        else { ttLogo.removeAttribute('src'); ttLogo.style.display='none'; ttLogo.alt=''; }
        moveTooltip(evt); tooltip.classList.add('show');
      }
      function moveTooltip(evt){
        const b = root.getBoundingClientRect();
        const x = Math.max(12, Math.min(evt.clientX - b.left, b.width - 12));
        const y = Math.max(12, Math.min(evt.clientY - b.top,  b.height - 12));
        tooltip.style.left = x + 'px'; tooltip.style.top  = y + 'px';
      }
      function hideTooltip(){ tooltip.classList.remove('show'); }
      function showDetails(d){
        dName.textContent = d.company || 'Member';
        dCompany.textContent = d.company || '—';
        dDesc.textContent = d.description || '—';
        dIndustry.textContent = d.industry || '—';

        if(IS_ADMIN){
          dId.textContent = d.recordId || '—';
          dCountry.textContent = d.country || '—';
          dTier.textContent = (d.membershipClass ? `${d.membershipClass}` : '—') + (d.membershipLevel ? ` (level ${d.membershipLevel})` : '');
          const classLine = document.getElementById('details-class');
          classLine.textContent = d.membershipLevel ? `Member category level ${d.membershipLevel}` : '';
          classLine.hidden = !d.membershipLevel;
        } else { document.getElementById('details-class').hidden = true; }

        if(d.website){
          let url = d.website; if(!/^https?:\/\//i.test(url)) url = 'https://' + url;
          dUrl.innerHTML = `<a href="${url}" target="_blank" rel="nofollow noopener">${url}</a>`;
        } else dUrl.textContent = '—';

        if(d.x){
          const xUrl = /^https?:\/\//i.test(d.x) ? d.x : `https://x.com/${String(d.x).replace(/^@/, '')}`;
          dX.innerHTML = `<a href="${xUrl}" target="_blank" rel="nofollow noopener">${xUrl}</a>`;
        } else dX.textContent = '—';

        if(d.linkedin){
          const liUrl = /^https?:\/\//i.test(d.linkedin) ? d.linkedin : `https://www.linkedin.com/company/${String(d.linkedin).replace(/^@/, '')}`;
          dLinkedIn.innerHTML = `<a href="${liUrl}" target="_blank" rel="nofollow noopener">${liUrl}</a>`;
        } else dLinkedIn.textContent = '—';

        const imgURL = d._logoURL || (logoCandidates(d)[0] || '');
        if(imgURL){ dLogo.src = imgURL; dLogo.style.display='block'; dLogo.alt = (d.company||'') + ' logo'; }
        else { dLogo.removeAttribute('src'); dLogo.style.display='none'; dLogo.alt=''; }

        details.hidden = false;
      }
    }

    /* ---------- helpers ---------- */
    function css(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }
    function normalizeKey(s){ return String(s||'').toLowerCase().replace(/&/g,'and').replace(/\s+/g,' ').trim(); }
    function titleCase(s){ return String(s||'').toLowerCase().replace(/(^|\s|-|_)\w/g, m => m.toUpperCase()); }
    function slugify(s){ return normalizeKey(s).replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
    function extractDomain(url){
      if(!url) return '';
      let u = url.trim(); if(!/^https?:/i.test(u)) u = 'https://' + u;
      try{ const {hostname} = new URL(u); return hostname.replace(/^www\./,''); }catch(_){ return ''; }
    }

    /* Robust candidate builder that understands subfolders & name variants */
    function logoCandidates(d){
      const cRaw = d.company || '';
      const domain = extractDomain(d.website);
      const fromData = (d.logo||'').trim();

      const cNorm = normalizeKey(cRaw);
      const cSlug = slugify(cRaw);
      const cTitle = titleCase(cRaw.replace(/&/g,'and'));
      const cPlain = cRaw.replace(/&/g,'and').trim();

      const baseNames = Array.from(new Set([cPlain, cTitle, cSlug]));
      const exts = ['svg','png','webp','jpg','jpeg'];

      // known folders plus guesses from membership level
      const commonFolders = ['', 'A1-Class','A-Class','A','B1-Class','B1','B','B2_Class','B2-Class','B2','B3_Class','B3-Class','B3','B2+B3-Tier','B2B3','D-Class','D_Tier','D'];
      const byLevel = new Map([
        [1,['A1-Class','A-Class','A']],
        [2,['B1-Class','B1','B']],
        [3,['B2_Class','B3_Class','B2-Class','B3-Class','B2','B3','B2+B3-Tier']],
        [4,['D-Class','D_Tier','D']]
      ]);
      const levelFolders = byLevel.get(d.membershipLevel) || [];
      const folders = Array.from(new Set(['', ...levelFolders, ...commonFolders]));

      const list = [];
      if(fromData) list.push(fromData);
      if(brandLogoMap[cNorm]) list.push(brandLogoMap[cNorm]);

      for(const folder of folders){
        for(const base of baseNames){
          for(const ext of exts){
            const p = folder ? `/logos/${folder}/${base}.${ext}` : `/logos/${base}.${ext}`;
            list.push(p);
          }
        }
      }
      for(const ext of exts){ list.push(`/logos/${cSlug}.${ext}`); }

      if(domain){
        list.push(`https://logo.clearbit.com/${domain}`);
        list.push(`https://www.google.com/s2/favicons?domain=${domain}&sz=128`);
      }
      return Array.from(new Set(list.filter(Boolean)));
    }

    // Modified: remember the URL each time we try one
    function tryNext(imgEl, urls, onFail){
      let i = 0;
      const trySet = ()=>{
        if(i >= urls.length){ onFail && onFail(); return; }
        const url = urls[i++];
        imgEl.__currentURL = url;              // <-- store the candidate
        imgEl.setAttribute('href', url);
        imgEl.setAttribute('xlink:href', url);
      };
      imgEl.addEventListener('error', trySet);
      trySet();
    }
  })();
  </script>
</body>
</html>
